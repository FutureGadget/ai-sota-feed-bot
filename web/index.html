<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Feed</title>
  <link rel="stylesheet" href="https://oat.ink/oat.min.css" />
  <script>
    (function () {
      var t = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <script src="https://oat.ink/oat.min.js" defer></script>
  <style>
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      margin: 0;
      line-height: 1.5;
      overflow-x: hidden;
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    main {
      width: 100%;
      max-width: 920px;
      margin: 1rem auto;
      padding: 0 0.9rem 2rem;
      overflow-x: clip;
    }
    header {
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .topbar h1 {
      margin: 0;
      font-size: 1.5rem;
      line-height: 1.2;
      overflow-wrap: anywhere;
    }
    menu {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0;
      margin: 0.75rem 0 0;
    }
    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.9rem;
    }
    .presets button {
      font-size: 0.9rem;
      padding: 0.3rem 0.55rem;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.6rem;
      margin-top: 0.8rem;
      align-items: end;
    }
    .filters label {
      font-size: 0.92rem;
      opacity: 0.9;
      display: block;
      margin-bottom: 0.25rem;
    }
    .filters .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    #list {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    article {
      padding: 1rem;
      border: 1px solid var(--border, #e5e5e5);
      border-radius: 10px;
      background: var(--card, #fff);
    }
    .thumb {
      display: block;
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      border: 1px solid var(--border, #e5e5e5);
    }
    article h3 {
      margin: 0 0 0.35rem;
      font-size: 1.15rem;
      line-height: 1.35;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    article h3 a {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin: 0.45rem 0;
      min-width: 0;
    }
    .badge {
      display: inline-block;
      max-width: 100%;
      border: 1px solid var(--border, #d9d9d9);
      border-radius: 999px;
      padding: 0.18rem 0.55rem;
      font-size: 0.86rem;
      opacity: 0.92;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .why {
      margin: 0.35rem 0 0;
      font-size: 1rem;
      line-height: 1.55;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .state {
      border: 1px dashed var(--border, #d9d9d9);
      border-radius: 10px;
      padding: 1rem;
      opacity: 0.85;
    }
    input, button, a[role="button"] {
      font-size: 16px;
    }
    @media (max-width: 640px) {
      main {
        margin-top: 0.75rem;
      }
      .topbar h1 {
        font-size: 1.35rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="topbar">
        <h1>ðŸ“° AI Feed</h1>
        <button id="themeToggle" type="button" aria-label="Toggle theme">ðŸŒ™ Dark</button>
      </div>
      <p id="meta">Loading...</p>
      <menu>
        <a href="/api/rss" role="button">RSS feed</a>
        <a href="/api/feed" role="button">JSON feed</a>
      </menu>

      <div class="presets" id="presets">
        <button type="button" data-days="0">Today</button>
        <button type="button" data-days="3">Last 3d</button>
        <button type="button" data-days="7">Last 7d</button>
        <button type="button" data-days="30">Last 30d</button>
        <button type="button" data-days="all">All</button>
      </div>

      <form id="filters" class="filters">
        <div>
          <label for="fromDate">From date</label>
          <input id="fromDate" name="from" type="date" />
        </div>
        <div>
          <label for="toDate">To date</label>
          <input id="toDate" name="to" type="date" />
        </div>
        <div>
          <label for="limit">Max items</label>
          <input id="limit" name="limit" type="number" min="1" max="500" value="200" />
        </div>
        <div class="actions">
          <button type="submit">Apply</button>
          <button id="clearFilters" type="button">Clear</button>
        </div>
      </form>
    </header>

    <section id="list" aria-live="polite"></section>
  </main>

  <script>
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    }

    function initThemeToggle() {
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current);
      btn.addEventListener('click', () => {
        const now = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(now === 'dark' ? 'light' : 'dark');
      });
    }

    function fmtDateTime(v) {
      if (!v) return null;
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return null;
      return d.toLocaleString();
    }

    function toIsoDateStart(dateStr) {
      if (!dateStr) return null;
      return `${dateStr}T00:00:00`;
    }

    function toIsoDateEnd(dateStr) {
      if (!dateStr) return null;
      return `${dateStr}T23:59:59`;
    }

    function toDateInput(d) {
      const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
      return local.toISOString().slice(0, 10);
    }

    function setDateRangeDays(days) {
      const fromEl = document.getElementById('fromDate');
      const toEl = document.getElementById('toDate');
      if (!fromEl || !toEl) return;

      if (days === 'all') {
        fromEl.value = '';
        toEl.value = '';
        return;
      }

      const n = Number(days);
      const now = new Date();
      const from = new Date(now.getTime() - n * 24 * 60 * 60 * 1000);
      fromEl.value = toDateInput(from);
      toEl.value = toDateInput(now);
    }

    function setDefaultFilterWindow() {
      setDateRangeDays(7);
    }

    function buildFeedUrl() {
      const fromDate = document.getElementById('fromDate')?.value || '';
      const toDate = document.getElementById('toDate')?.value || '';
      const from = toIsoDateStart(fromDate);
      const to = toIsoDateEnd(toDate);
      const limit = document.getElementById('limit')?.value || '200';
      const anon = getAnonUserId();
      const u = new URL('/api/feed', window.location.origin);
      if (from) u.searchParams.set('from', from);
      if (to) u.searchParams.set('to', to);
      if (limit) u.searchParams.set('limit', limit);
      if (anon) u.searchParams.set('anon_user_id', anon);
      return u.pathname + u.search;
    }

    function esc(v) {
      return String(v ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function safeUrl(v) {
      try {
        const u = new URL(String(v || ''), window.location.origin);
        if (u.protocol === 'http:' || u.protocol === 'https:') return u.href;
      } catch {}
      return '#';
    }

    function randomId(prefix = 'id') {
      if (window.crypto?.randomUUID) return `${prefix}_${window.crypto.randomUUID()}`;
      return `${prefix}_${Math.random().toString(36).slice(2)}_${Date.now()}`;
    }

    function getAnonUserId() {
      const key = 'ai_feed_anon_user_id';
      let v = localStorage.getItem(key);
      if (!v) {
        v = randomId('anon');
        localStorage.setItem(key, v);
      }
      return v;
    }

    function getSessionId() {
      const key = 'ai_feed_session_id';
      let v = sessionStorage.getItem(key);
      if (!v) {
        v = randomId('sess');
        sessionStorage.setItem(key, v);
      }
      return v;
    }

    async function sendEvents(events) {
      if (!events?.length) return;
      try {
        await fetch('/api/events', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ events }),
          keepalive: true,
        });
      } catch (e) {
        console.debug('event_send_failed', e);
      }
    }

    async function run() {
      const list = document.getElementById('list');
      const res = await fetch(buildFeedUrl());
      if (!res.ok) throw new Error(`feed_http_${res.status}`);

      const data = await res.json();
      const items = data.items || [];
      const runs = data.runs || [];
      const anonUserId = getAnonUserId();
      const sessionId = getSessionId();
      const runId = runs?.[0]?.run_at || null;

      document.getElementById('meta').textContent = `${items.length} items Â· ${runs.length} runs in range`;

      if (!items.length) {
        list.innerHTML = `<div class="state">No items for that date/time range. Try widening the window.</div>`;
        return;
      }

      list.innerHTML = items.map((it, i) => {
        const seen = fmtDateTime(it.last_seen) || fmtDateTime(it.first_seen);
        const title = esc(it.title || 'Untitled');
        const source = esc(it.source || 'unknown');
        const type = esc(it.type || 'news');
        const maturity = esc(it.maturity || '');
        const summaryRaw = String(it.summary_1line || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
        const summary = esc(summaryRaw);
        const seenText = seen ? esc(seen) : '';
        const href = safeUrl(it.url);
        const image = safeUrl(it.image_url || '');
        const itemId = esc(it.id || `${it.url || ''}::${it.title || ''}`);

        return `
        <article>
          ${image !== '#' ? `<img class="thumb" src="${image}" alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer" onerror="this.style.display='none';this.remove();" />` : ''}
          <h3>${i + 1}. <a href="${href}" target="_blank" rel="noopener" data-track="item-link" data-item-id="${itemId}" data-source="${source}" data-rank="${i + 1}" data-run-id="${esc(runId || '')}" data-title="${title}">${title}</a></h3>
          <div class="meta-row">
            <span class="badge">${source}</span>
            <span class="badge">${type}</span>
            ${maturity ? `<span class="badge">${maturity}</span>` : ''}
            ${seenText ? `<span class="badge">Last seen: ${seenText}</span>` : ''}
          </div>
          ${summary ? `<p class="why">${summary}</p>` : ''}
        </article>`;
      }).join('');

      const impressions = items.slice(0, 200).map((it, i) => ({
        anon_user_id: anonUserId,
        session_id: sessionId,
        event_type: 'impression',
        item_id: it.id || `${it.url || ''}::${it.title || ''}`,
        title: it.title || '',
        url: it.url || '',
        source: it.source || '',
        rank_position: i + 1,
        run_id: runId,
        ts: new Date().toISOString(),
      }));
      sendEvents(impressions);
    }

    function initClickTracking() {
      const list = document.getElementById('list');
      if (!list) return;

      list.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-track="item-link"]');
        if (!a) return;

        const event = {
          anon_user_id: getAnonUserId(),
          session_id: getSessionId(),
          event_type: 'click',
          item_id: a.dataset.itemId || null,
          title: a.dataset.title || null,
          url: a.getAttribute('href') || null,
          source: a.dataset.source || null,
          rank_position: Number(a.dataset.rank || 0) || null,
          run_id: a.dataset.runId || null,
          ts: new Date().toISOString(),
        };
        sendEvents([event]);
      });
    }

    function initFilters() {
      const form = document.getElementById('filters');
      const clearBtn = document.getElementById('clearFilters');
      const presets = document.getElementById('presets');
      if (!form) return;

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        run().catch(err => {
          document.getElementById('meta').textContent = 'Feed unavailable';
          document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
          console.error(err);
        });
      });

      presets?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-days]');
        if (!btn) return;
        setDateRangeDays(btn.dataset.days);
        run().catch(err => {
          document.getElementById('meta').textContent = 'Feed unavailable';
          document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
          console.error(err);
        });
      });

      clearBtn?.addEventListener('click', () => {
        document.getElementById('fromDate').value = '';
        document.getElementById('toDate').value = '';
        document.getElementById('limit').value = '200';
        run().catch(err => {
          document.getElementById('meta').textContent = 'Feed unavailable';
          document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
          console.error(err);
        });
      });
    }

    initThemeToggle();
    setDefaultFilterWindow();
    initFilters();
    initClickTracking();
    run().catch(err => {
      document.getElementById('meta').textContent = 'Feed unavailable';
      document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
      console.error(err);
    });
  </script>
</body>
</html>
