<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Feed</title>
  <link rel="stylesheet" href="https://oat.ink/oat.min.css" />
  <script>
    (function () {
      var t = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <script src="https://oat.ink/oat.min.js" defer></script>
  <style>
    main {
      max-width: 920px;
      margin: 2rem auto;
      padding: 0 1rem 2rem;
    }
    header {
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .topbar h1 {
      margin: 0;
    }
    menu {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0;
      margin: 0.75rem 0 0;
    }
    #list {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    article {
      padding: 0.9rem 1rem;
      border: 1px solid var(--border, #e5e5e5);
      border-radius: 10px;
      background: var(--card, #fff);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin: 0.45rem 0;
    }
    .badge {
      display: inline-block;
      border: 1px solid var(--border, #d9d9d9);
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .why {
      margin: 0.25rem 0 0;
    }
    .state {
      border: 1px dashed var(--border, #d9d9d9);
      border-radius: 10px;
      padding: 1rem;
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="topbar">
        <h1>ðŸ“° AI Feed</h1>
        <button id="themeToggle" type="button" aria-label="Toggle theme">ðŸŒ™ Dark</button>
      </div>
      <p id="meta">Loading...</p>
      <menu>
        <a href="/api/rss" role="button">RSS feed</a>
        <a href="/api/feed" role="button">JSON feed</a>
      </menu>
    </header>

    <section id="list" aria-live="polite"></section>
  </main>

  <script>
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    }

    function initThemeToggle() {
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current);
      btn.addEventListener('click', () => {
        const now = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(now === 'dark' ? 'light' : 'dark');
      });
    }

    async function run() {
      const list = document.getElementById('list');
      const res = await fetch('/api/feed');
      if (!res.ok) throw new Error(`feed_http_${res.status}`);

      const data = await res.json();
      const items = data.items || [];
      document.getElementById('meta').textContent = `${data.date || ''} Â· ${items.length} items`;

      if (!items.length) {
        list.innerHTML = `<div class="state">No items yet. Try again after the next pipeline run.</div>`;
        return;
      }

      list.innerHTML = items.map((it, i) => `
        <article>
          <h3>${i + 1}. <a href="${it.url || '#'}" target="_blank" rel="noopener">${it.title || 'Untitled'}</a></h3>
          <div class="meta-row">
            <span class="badge">${it.source || 'unknown'}</span>
            <span class="badge">${it.type || 'news'}</span>
            ${it.maturity ? `<span class="badge">${it.maturity}</span>` : ''}
          </div>
          <p class="why">${it.why_it_matters || ''}</p>
        </article>
      `).join('');
    }

    initThemeToggle();
    run().catch(err => {
      document.getElementById('meta').textContent = 'Feed unavailable';
      document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
      console.error(err);
    });
  </script>
</body>
</html>
