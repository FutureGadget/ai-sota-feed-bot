<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Feed</title>
  <link rel="stylesheet" href="https://oat.ink/oat.min.css" />
  <script>
    (function () {
      var t = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>
  <script src="https://oat.ink/oat.min.js" defer></script>
  <style>
    main {
      max-width: 920px;
      margin: 2rem auto;
      padding: 0 1rem 2rem;
    }
    header {
      margin-bottom: 1rem;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .topbar h1 {
      margin: 0;
    }
    menu {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0;
      margin: 0.75rem 0 0;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.6rem;
      margin-top: 0.9rem;
      align-items: end;
    }
    .filters label {
      font-size: 0.85rem;
      opacity: 0.85;
      display: block;
      margin-bottom: 0.2rem;
    }
    .filters .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    #list {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    article {
      padding: 0.9rem 1rem;
      border: 1px solid var(--border, #e5e5e5);
      border-radius: 10px;
      background: var(--card, #fff);
    }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin: 0.45rem 0;
    }
    .badge {
      display: inline-block;
      border: 1px solid var(--border, #d9d9d9);
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .why {
      margin: 0.25rem 0 0;
    }
    .state {
      border: 1px dashed var(--border, #d9d9d9);
      border-radius: 10px;
      padding: 1rem;
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="topbar">
        <h1>ðŸ“° AI Feed</h1>
        <button id="themeToggle" type="button" aria-label="Toggle theme">ðŸŒ™ Dark</button>
      </div>
      <p id="meta">Loading...</p>
      <menu>
        <a href="/api/rss" role="button">RSS feed</a>
        <a href="/api/feed" role="button">JSON feed</a>
      </menu>

      <form id="filters" class="filters">
        <div>
          <label for="fromDt">From</label>
          <input id="fromDt" name="from" type="datetime-local" />
        </div>
        <div>
          <label for="toDt">To</label>
          <input id="toDt" name="to" type="datetime-local" />
        </div>
        <div>
          <label for="limit">Max items</label>
          <input id="limit" name="limit" type="number" min="1" max="500" value="200" />
        </div>
        <div class="actions">
          <button type="submit">Apply</button>
          <button id="clearFilters" type="button">Clear</button>
        </div>
      </form>
    </header>

    <section id="list" aria-live="polite"></section>
  </main>

  <script>
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const btn = document.getElementById('themeToggle');
      if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    }

    function initThemeToggle() {
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current);
      btn.addEventListener('click', () => {
        const now = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(now === 'dark' ? 'light' : 'dark');
      });
    }

    function fmtDateTime(v) {
      if (!v) return null;
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return null;
      return d.toLocaleString();
    }

    function toIsoFromLocal(v) {
      if (!v) return null;
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? null : d.toISOString();
    }

    function setDefaultFilterWindow() {
      const fromEl = document.getElementById('fromDt');
      const toEl = document.getElementById('toDt');
      if (!fromEl || !toEl) return;

      const now = new Date();
      const before = new Date(now.getTime() - 48 * 60 * 60 * 1000);
      const toLocalInput = (d) => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

      fromEl.value = toLocalInput(before);
      toEl.value = toLocalInput(now);
    }

    function buildFeedUrl() {
      const from = toIsoFromLocal(document.getElementById('fromDt')?.value || '');
      const to = toIsoFromLocal(document.getElementById('toDt')?.value || '');
      const limit = document.getElementById('limit')?.value || '200';
      const u = new URL('/api/feed', window.location.origin);
      if (from) u.searchParams.set('from', from);
      if (to) u.searchParams.set('to', to);
      if (limit) u.searchParams.set('limit', limit);
      return u.pathname + u.search;
    }

    async function run() {
      const list = document.getElementById('list');
      const res = await fetch(buildFeedUrl());
      if (!res.ok) throw new Error(`feed_http_${res.status}`);

      const data = await res.json();
      const items = data.items || [];
      const runs = data.runs || [];
      document.getElementById('meta').textContent = `${items.length} items Â· ${runs.length} runs in range`;

      if (!items.length) {
        list.innerHTML = `<div class="state">No items for that date/time range. Try widening the window.</div>`;
        return;
      }

      list.innerHTML = items.map((it, i) => {
        const seen = fmtDateTime(it.last_seen) || fmtDateTime(it.first_seen);
        return `
        <article>
          <h3>${i + 1}. <a href="${it.url || '#'}" target="_blank" rel="noopener">${it.title || 'Untitled'}</a></h3>
          <div class="meta-row">
            <span class="badge">${it.source || 'unknown'}</span>
            <span class="badge">${it.type || 'news'}</span>
            ${it.maturity ? `<span class="badge">${it.maturity}</span>` : ''}
            ${seen ? `<span class="badge">Last seen: ${seen}</span>` : ''}
          </div>
          ${it.summary_1line ? `<p class="why">${it.summary_1line}</p>` : ''}
        </article>`;
      }).join('');
    }

    function initFilters() {
      const form = document.getElementById('filters');
      const clearBtn = document.getElementById('clearFilters');
      if (!form) return;

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        run().catch(err => {
          document.getElementById('meta').textContent = 'Feed unavailable';
          document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
          console.error(err);
        });
      });

      clearBtn?.addEventListener('click', () => {
        document.getElementById('fromDt').value = '';
        document.getElementById('toDt').value = '';
        document.getElementById('limit').value = '200';
        run().catch(err => {
          document.getElementById('meta').textContent = 'Feed unavailable';
          document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
          console.error(err);
        });
      });
    }

    initThemeToggle();
    setDefaultFilterWindow();
    initFilters();
    run().catch(err => {
      document.getElementById('meta').textContent = 'Feed unavailable';
      document.getElementById('list').innerHTML = `<div class="state">Could not load the feed right now. Please refresh in a moment.</div>`;
      console.error(err);
    });
  </script>
</body>
</html>
